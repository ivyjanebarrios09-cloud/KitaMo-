
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isStudent() {
      // Check if user has a 'student' role in their user document
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }

    // Users can read and write their own profile and joined rooms list.
    match /users/{userId} {
      allow read, write: if isOwner(userId);

       match /joinedRooms/{roomId} {
        allow read, write: if isOwner(userId);
       }
    }
    
    // A user can manage the rooms, members, expenses, deadlines, and payments within their own subcollection.
    match /users/{userId}/rooms/{roomId} {
       allow read, create, update, delete: if isOwner(userId);

       match /members/{memberId} {
         // Any signed in user can join a room (create a member doc for themselves)
         allow create: if isSignedIn();
         // Room owner can read member list
         allow read, list: if isOwner(userId);
       }
       
       match /expenses/{expenseId} {
          // Room owner can manage expenses
          allow read, write: if isOwner(userId);

          match /seenBy/{studentId} {
            // A student can mark a post as seen for themselves
            allow create, read: if isOwner(studentId);
            // The room owner can list who has seen the post
            allow list: if isOwner(userId);
          }
       }

       match /deadlines/{deadlineId} {
          // Room owner can manage deadlines
          allow read, write: if isOwner(userId);

          match /seenBy/{studentId} {
            // A student can mark a post as seen for themselves
            allow create, read: if isOwner(studentId);
            // The room owner can list who has seen the post
            allow list: if isOwner(userId);
          }
       }
       
       match /payments/{paymentId} {
          // Room owner can manage payments
          allow read, write: if isOwner(userId);
       }
    }

    // This collection is used to find rooms by their code. Anyone can read.
    match /roomCodes/{code} {
        allow read: if isSignedIn();
        // Writes should only be done via a Cloud Function to ensure consistency.
        // The client-side batch write will attempt this, but will be blocked by this rule.
        allow write: if false; 
    }
  }
}
